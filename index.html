<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title>CFG Playground</title>
  <meta name="description" content="CFG Playground">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Overpass|Overpass Mono|Roboto|Roboto Mono|Manrope&amp;display=swap">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css"
        integrity="sha256-Ww++W3rXBfapN8SZitAvc9jw2Xb+Ixt0rvDsmWmQyTo=" crossorigin="anonymous">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/lib/codemirror.css"
        integrity="sha256-F8x+Z3ibZvrT6AYhdYRAhBaA77XYocFUTGA/lMGNVYE=" crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha256-9nt4LsWmLI/O24lTW89IzAKuBqEZ47l/4rh1+tH/NY8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.54.0/lib/codemirror.js"
          integrity="sha256-HMBMEGw3DHPgAM4ZYslxP1/75uRlvol/56G4+o+nud0=" crossorigin="anonymous"></script>

  <script src="dist/config.js"></script>
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <style>
    html, body {
      height: 100%;
    }
    body {
      font-family: Overpass;
      font-size: 16px;
    }
    .CodeMirror {
      font-size: 14px;
      height: 100%;
    }
  </style>
  <div class="p-2 d-flex h-100">
    <div class="w-50 h-100 p-2 d-flex flex-column">
      <div>You can edit the CFG source below, and see the results at right:</div>
      <textarea id="source" class="w-100 flex-grow-1"># You can have comments anywhere in a configuration.
{
  # You can have standard JSON-like key-value mapping.
  "writer": "Oscar Fingal O'Flahertie Wills Wilde",
  # But also use single-quotes for keys and values.
  'a dimension': 'length: 5"',
  # You can use identifiers for the keys.
  string_value: 'a string value',
  integer_value: 3,
  float_value = 2.71828,         # you can use = instead of : as a key-value separator
  boolean_value: true,           # these values are just like in JSON
  opposite_boolean_value: false,
  null_value: null
  list_value: [
    123,
    4.5  # note the absence of a comma - a newline acts as a separator, too.
    [
      1,
      'A',
      2,
      'b',  # note the trailing comma - doesn't cause errors
    ]
  ]  # a comma isn't needed here.
  nested_mapping: {
    integer_as_hex: 0x123
    float_value: .14159,  # note the trailing comma - doesn't cause errors
  } # no comma needed here either.
  # You can use escape sequences ...
  snowman_escaped: '\u2603'
  # or not, and use e.g. utf-8 encoding.
  snowman_unescaped: 'â˜ƒ'
  # You can refer to code points outside the Basic Multilingual Plane
  face_with_tears_of_joy: '\U0001F602'
  unescaped_face_with_tears_of_joy: 'ðŸ˜‚'
  # Refer to other values in this configuration.
  refer_1: ${string_value},                  # -> 'a string value'
  refer_2: ${list_value[1]},                 # -> 4.5
  refer_3: ${nested_mapping.float_value},    # -> 0.14159
  # Special values are implementation-dependent.
  s_val_1: `$LANG|en_GB.UTF-8`               # -> environment var with default
  s_val_2: `2019-03-28T23:27:04.314159`      # -> date/time value

  # Expressions.
  # N.B. backslash immediately followed by newline is seen as a continuation:
  pi_approx: ${integer_value} + \
              ${nested_mapping.float_value}   # -> 3.14159
  sept_et_demi: ${integer_value} + \
                ${list_value[1]}             # -> 7.5
}</textarea>
    </div>
    <div class="w-50 h-100 p-2 d-flex flex-column">
      <div>The results of parsing the CFG at left are shown below:</div>
      <textarea id="output" class="w-100 flex-grow-1"></textarea>
    </div>
  </div>
  <script>
    // define a CFG mode for the editor.

    CodeMirror.defineMode('cfg', function(config, modeConfig) {

      // return the mode object
      return {
        startState: function() {
          return { line: 1};
        },
        blankLine: function(state) {
          state.line++;
        },
        token: function(stream, state) {
          let s = stream.peek();
          let result = null;

          if (s === ' ') {
            stream.eatSpace();
          }
          else if (s === '#') {
            stream.skipToEnd();
            result = 'comment';
          }
          else if ((s === '"') || (s === "'") || (s === '\`')) {
            let quote = stream.next();
            let last = null;

            while (s = stream.next()) {
              if ((s === quote) && (last !== '\\')) {
                break;
              }
              last = s;
            }
            result = s ? 'string' : 'string error';
          }
          else if (/[a-z_]/i.test(s)) {
            let v = stream.match(/[a-z_]\w*/i, true);
            let w = v[0];
            result = ((w === 'true') || (w === 'false') || (w === 'null')) ? 'atom' : 'variable';
          }
          else if (s === '0') {
            if (stream.match(/0b[01]+/i, true)) {
              result = 'number';
            }
            else if (stream.match(/0o[0-7]+/i, true)) {
              result = 'number';
            }
            else if (stream.match(/0x[0-9a-f]+/i, true)) {
              result = 'number';
            }
            else {
              stream.next();
              result = 'number';
            }
          }
          else if (/\d/.test(s)) {
            let v = stream.match(/\d+(_\d+)*(\.(\d+(_\d)*)?)?(e-?\d+)?j?/i, true);
            result = 'number';
          }
          else if (s === '.') {
            let v;

            s = stream.next();
            if (v = stream.match(/\d+(_\d+)*(e-?\d+(_\d+)*)?j?/i, true)) {
              result = 'number';
            }
            else {
              result = 'operator';
            }
          }
          else if ('=<>&|^+-*/%!'.indexOf(s) >= 0) {
            if (stream.match(/==|[<>!]=?|<>|&&|[|][|]?/, true)) {
              result = 'operator';
            }
            else {
              s = stream.next();
            }
          }
          else {
            s = stream.next();
          }
          // console.log(state, stream.current(), result);
          if (!stream.peek()) {
            state.line++;
          }
          return result;
        }
      }
    });

    let ocm;

    function logTokens(s) {
      let stream = CFG.makeStream(s);
      let tokenizer = new CFG.Tokenizer(stream);
      let token;

      while (token = tokenizer.getToken()) {
        console.log(token);
        if (token.kind === CFG.TokenKind.EOF) {
          break;
        }
      }
    }

    function populateOutput(cm) {
      let s = cm.getDoc().getValue();
      try {
        let stream = CFG.makeStream(s);
        let cfg = new CFG.Config(stream);
        let d = cfg.asDict();
        let o = JSON.stringify(d, null, 2);
        ocm.getDoc().setValue(o);
      }
      catch (err) {
        let loc = err.location;
        let lines = s.split('\n');

        console.log(lines);
        logTokens(s);
        console.error('error:', err);
      }
    }

    function onChange(cm, e) {
      populateOutput(cm);
    }

    $(document).ready(function() {
      let $sta = $('#source');
      let $ota = $('#output');

      let sourceOptions = {
        lineNumbers: true,
        mode: 'cfg'
      };
      let outputOptions = {
        lineNumbers: true,
        readOnly: true,
        mode: 'application/json'
      }

      let scm = CodeMirror.fromTextArea($sta[0], sourceOptions);
      ocm = CodeMirror.fromTextArea($ota[0], outputOptions);

      populateOutput(scm);
      scm.on('change', onChange);
    });
  </script>
</body>

</html>
